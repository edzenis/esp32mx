name: Build & Publish OTA Firmware

on:
  workflow_dispatch:

concurrency:
  group: ota-build-main
  cancel-in-progress: true

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout code  
        uses: actions/checkout@v4  
        with:  
          fetch-depth: 0  

      - name: Install Arduino CLI via install.sh  
        run: |  
          CLI_VER=0.36.2  
          echo "Installing Arduino CLI v${CLI_VER}â€¦"  
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh \  
            | sh -s ${CLI_VER}  
          echo "Adding \$PWD/bin to PATH"  
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH  
          echo "arduino-cli â†’ $(which arduino-cli)"  
          arduino-cli version  

      - name: Compile firmware  
        run: |  
          echo "Updating index & installing ESP32 coreâ€¦"  
          arduino-cli core update-index  
          arduino-cli core install esp32:esp32  
          echo "Building sketchâ€¦"  
          arduino-cli compile --fqbn esp32:esp32:esp32 src/maintainx_meter.ino  

      - name: Prepare firmware.bin  
        run: |  
          mkdir -p build  
          cp $(find . -name '*.ino.bin') build/firmware.bin  

      - name: Commit firmware.bin  
        uses: stefanzweifel/git-auto-commit-action@v4  
        with:  
          commit_message: "ðŸ”„ Automated firmware build for version $(cat version.txt)"  
          file_pattern: build/firmware.bin  
          branch: main  
          author_name: github-actions  
          author_email: github-actions@users.noreply.github.com  
