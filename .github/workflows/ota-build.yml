# .github/workflows/ota-build.yml
name: Build & Publish OTA Firmware

on:
  workflow_dispatch:
  push:
    paths:
      - 'src/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Arduino CLI
        uses: arduino/setup-arduino@v1
        with:
          version: latest

      - name: Compile firmware
        run: |
          # ensure clean build dir
          rm -rf build && mkdir build
          # compile the sketch in src/src.ino
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --output-dir build \
            src

      - name: Prepare firmware.bin
        run: |
          # grab whatever .bin was generated
          BIN=$(find build -maxdepth 1 -type f -name '*.bin' | head -n1)
          if [ -z "$BIN" ]; then
            echo "‚ùå No .bin found in build/"; exit 1
          fi
          echo "‚Üí found binary: $BIN"
          cp "$BIN" firmware.bin
          ls -lh firmware.bin

      - name: Commit & Push firmware.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git remote set-url origin \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git add firmware.bin
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to firmware.bin; skipping commit."
          else
            git commit -m "üîÑ Automated firmware build: $(cat version.txt)"
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: Upload firmware.bin to OTA server
        env:
          OTA_USER: root
          OTA_SERVER: 65.109.173.41
          OTA_PATH: /srv/firmware/firmware.bin
        run: |
          scp -i ~/.ssh/id_ed25519 \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              firmware.bin \
              $OTA_USER@$OTA_SERVER:$OTA_PATH
