name: Build & Publish OTA Firmware

on:
  workflow_dispatch:
  push:
    paths:
      - 'src/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: self-hosted

    steps:
      # 1) Checkout your code
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # 2) Sanity‚Äêcheck that Arduino CLI is present
      - name: Verify Arduino CLI
        run: |
          command -v arduino-cli >/dev/null \
            || { echo "‚ùå arduino-cli missing"; exit 1; }
          arduino-cli version

      # 3) Clean & compile the sketch in src/src.ino
      - name: Compile firmware
        run: |
          rm -rf build && mkdir build
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --output-dir build \
            src

      # 4) Copy out the generated .bin to firmware.bin at repo root
      - name: Prepare firmware.bin
        run: |
          BIN=$(find build -maxdepth 1 -type f -name '*.bin' | head -n1)
          if [ -z "$BIN" ]; then
            echo "‚ùå No .bin found in build/"; exit 1
          fi
          cp "$BIN" firmware.bin
          ls -lh firmware.bin

      # 5) Commit & push firmware.bin only if it changed
      - name: Commit & Push firmware.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git remote set-url origin \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git add firmware.bin
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to firmware.bin‚Äîskipping commit."
          else
            git commit -m "üîÑ Automated firmware build: $(cat version.txt)"
            git push origin HEAD:${{ github.ref_name }}
          fi

      # 6) Upload via SSH using the mounted key and known_hosts
      - name: Upload firmware.bin to OTA server
        env:
          OTA_USER: root
          OTA_SERVER: 65.109.173.41
          OTA_PATH: /srv/firmware/firmware.bin
        run: |
          scp -i ~/.ssh/id_ed25519 \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              firmware.bin \
              $OTA_USER@$OTA_SERVER:$OTA_PATH
